---
title: Hexo使用TravisCI自动部署到github pages
---
Hexo每次上传都需要generate & deploy, 相当不方便, 使用travis的持续集成可以省去繁琐的步骤快速上传, 提升写博客的体验~

<!-- more -->
### Github 

为了和gitlab的key区分开, 我重新生成了一对ssh-key

``` bash
# 生成自己的ssh-key
ssh-keygen -t rsa -C username@mail.com -b 4096

# 如果有多个ssh-key存在, 添加ssh-key
ssh-add ~/.ssh/id_rsa

# 查看添加的ssh-key是否存在
ssh-add -l

# 测试连接
ssh -T git@github.com

# 添加个人信息
git config user.name vvalkyrja
git config user.email mail@mail.com
```


### Hexo

参考[hexo官方文档](https://hexo.io)

``` bash
npm install hexo-cli -g
hexo init blog
cd blog
npm install
hexo server
```

主题使用vue风格的[apollo](https://github.com/pinggod/hexo-theme-apollo)

下载好apollo的主题文件后, 需要把.git删掉, 作为repo的一部分上传到git, 方便管理

需要注意的是, github pages只对master分支有效, 因此配置信息需要push到source分支

每次让travis从source分支拉取配置和源代码, 生成好之后上传到master即可

``` bash
# 删除.git
rm -rf ./themes/apollo/.git/

# 新建并切换分支, 添加到git
git checkout -b source 
git add .
```

<div class='tip'>
    添加文件到git时可能会提示: fatal: Pathspec '.' is in submodule, 这是由于git的文件夹缓存还在, 需要手动删除
    $ git rm --cached directory
</div>



因为把部署的步骤放到了travis来做, 因此许多文件是不需要上传到git的, travis会根据指令来安装和初始化, 多余的文件gitignore掉

``` gitignore
.DS_Store
Thumbs.db
*.log
db.json
node_modules/
public/
.deploy*/
```


### Travis

使用Github账户登陆Travis CI, 在github上生成拥有public repo权限的[Personal access tokens](https://github.com/settings/tokens)

Travis中勾选自己从github上同步过来的repo, 进行设置

环境变量加入刚才获得的token {GH_TOKEN: your_token}

在repo中创建[.travis.yml], 配置持续集成

``` bash
language: node_js

node_js: stable

install:
  - npm install

script:
  - hexo cl
  - hexo g

after_script:
  - cd ./public
  - git init
  - git config user.name "travis"
  - git config user.email ""
  - git add .
  - git commit -m "travis update"
  - git push --force --quiet "https://${GH_TOKEN}@${GH_REF}" master:master

branches:
  only:
    - source
env:
 global:
   - GH_REF: github.com/username/repo.git
```

最后再push一次到source分支, travis CI就会开始持续集成的工作, 将hexo generate好的文档push到master分支, 由github pages托管


### 自定义域名

如果要使用自定义的域名, 只需要在repo settings里加上即可, 同时github会在master里生成CNAME文件来做标示

但travis使用的是force push, 因此需要在源文件中把CNAME加上

``` bash
echo vvalkyrja.com >> ./source/CNAME
```


### 添加About页面

apollo主题默认不带about me页面, 我们可以利用hexo来添加

``` bash
hexo new page 'about'
```

./source下会生成/about 并带有index.md, 将其作为about页面即可, 当然还是要在_config里设置的~


### 大功告成

使用TravisCI之后, 再也不用手动hexo g && hexo d了

只需要在./source/_posts下写好md, 直接push即可完成自动部署

如果使用的是gitlab作为代码仓库, 也可以用gitlab-ci来完成部署


#### 参考资料
* [使用 Travis CI 自动部署 Hexo](http://www.jianshu.com/p/5e74046e7a0f)
* [使用Travis CI自动部署你的Hexo博客到Github](http://www.selfrebuild.net/2016/11/16/github-hexo-blog-auto-deploy/)
* [手把手教你使用Travis CI自动部署你的Hexo博客到Github上](http://www.jianshu.com/p/e22c13d85659)